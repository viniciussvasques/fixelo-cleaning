# =============================================
# FIXELO - SSH Deploy to Production
# =============================================
name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # BUILD & TEST
  # ============================================
  build:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate

      - name: TypeScript Check
        run: npm run type-check

      - name: Build Application
        run: npm run build
        env:
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          SKIP_ENV_VALIDATION: 'true'

  # ============================================
  # DEPLOY TO SERVER
  # ============================================
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file content
        id: env_file
        run: |
          cat << 'EOF' > env_content.txt
          # Domain
          DOMAIN=${{ secrets.DOMAIN || 'fixelo.app' }}
          NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL || 'https://fixelo.app' }}
          ACME_EMAIL=${{ secrets.ACME_EMAIL || 'admin@fixelo.app' }}
          
          # Database
          POSTGRES_USER=${{ secrets.POSTGRES_USER || 'fixelo' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB || 'fixelo_prod' }}
          
          # Auth
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          
          # Stripe
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          
          # Email
          SMTP_HOST=${{ secrets.SMTP_HOST || 'my.mailbux.com' }}
          SMTP_PORT=${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM=${{ secrets.SMTP_FROM || 'no-reply@fixelo.app' }}
          
          # Twilio (optional)
          TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
          EOF

      - name: Setup and Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_CONTENT: ${{ steps.env_file.outputs.env_content }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 25m
          script: |
            set -e
            
            echo "üìÅ Navigating to project directory..."
            mkdir -p /srv/fixelo
            cd /srv/fixelo
            
            # Clone or update repo
            if [ ! -d ".git" ]; then
              echo "üì• Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "üì• Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main
            fi
            
            # Create .env if it doesn't exist
            if [ ! -f ".env" ]; then
              echo "üîß Creating .env file..."
              cat > .env << 'ENVEOF'
            # Domain
            DOMAIN=fixelo.app
            NEXT_PUBLIC_APP_URL=https://fixelo.app
            ACME_EMAIL=admin@fixelo.app
            
            # Database
            POSTGRES_USER=fixelo
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=fixelo_prod
            
            # Auth
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            
            # Stripe (configure later)
            STRIPE_SECRET_KEY=sk_test_placeholder
            NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_placeholder
            STRIPE_WEBHOOK_SECRET=whsec_placeholder
            
            # Email (configure later)
            SMTP_HOST=my.mailbux.com
            SMTP_PORT=587
            SMTP_USER=no-reply@fixelo.app
            SMTP_PASSWORD=placeholder
            SMTP_FROM=no-reply@fixelo.app
            ENVEOF
            fi
            
            # Make deploy script executable
            chmod +x scripts/deploy.sh
            
            # Run deployment
            echo "üöÄ Running deployment..."
            
            # Build images
            echo "üê≥ Building Docker images..."
            docker compose -f docker-compose.prod.yml build --parallel
            
            # Start database first
            echo "üóÉÔ∏è Starting database..."
            docker compose -f docker-compose.prod.yml up -d db redis traefik
            
            # Wait for database
            echo "‚è≥ Waiting for database..."
            sleep 10
            
            # Run migrations
            echo "üìä Running migrations..."
            docker compose -f docker-compose.prod.yml --profile migration run --rm migrate || echo "Migrations may have already been applied"
            
            # Start web
            echo "üåê Starting web application..."
            docker compose -f docker-compose.prod.yml up -d web
            
            # Cleanup
            echo "üßπ Cleanup..."
            docker image prune -f
            
            echo "‚úÖ Deployment complete!"
            docker compose -f docker-compose.prod.yml ps

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "‚è≥ Waiting for service to start..."
            sleep 30
            
            if docker ps | grep -q "fixelo-web"; then
              echo "‚úÖ Web container is running"
            else
              echo "‚ùå Web container is not running"
              docker logs fixelo-web --tail 50 || true
              exit 1
            fi
            
            # Try health check with retries
            for i in 1 2 3 4 5; do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed!"
                exit 0
              fi
              echo "‚è≥ Retry $i..."
              sleep 10
            done
            
            echo "‚ö†Ô∏è Health check failed (app might still be starting)"

      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Deployment failed!"
