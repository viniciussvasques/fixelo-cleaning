# =============================================
# FIXELO - SSH Deploy to Production
# =============================================
name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # BUILD & TEST
  # ============================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate

      - name: TypeScript Check
        run: npm run type-check

      - name: Build Application
        run: npm run build
        env:
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          SKIP_ENV_VALIDATION: 'true'

  # ============================================
  # DEPLOY TO SERVER
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            
            echo "ğŸ“ Creating project directory..."
            mkdir -p /srv/fixelo
            cd /srv/fixelo
            
            # Initialize or update git repo
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "ğŸ“¥ Pulling latest code..."
              git fetch origin main
              git reset --hard origin/main
            fi
            
            echo "ğŸ³ Building Docker containers..."
            docker compose -f docker-compose.prod.yml build \
              --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" \
              --build-arg NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}" \
              --build-arg NEXT_PUBLIC_VAPID_PUBLIC_KEY="${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}" \
              --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}"
            
            echo "ğŸš€ Starting containers..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
            docker ps

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "â³ Waiting for service to start..."
            sleep 30
            
            if docker ps | grep -q "fixelo-web"; then
              echo "âœ… Web container is running"
            else
              echo "âŒ Web container is not running"
              docker logs fixelo-web --tail 50 || true
              exit 1
            fi
            
            if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed"
            else
              echo "âš ï¸ Health check failed (might still be starting)"
            fi

      - name: Notify on failure
        if: failure()
        run: echo "âŒ Deployment failed!"
