# =============================================
# FIXELO - SSH Deploy to Production
# =============================================
# Triggered on push to main/master branch
# Deploys via SSH to Linux server with Docker
# =============================================

name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild (ignore cache)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  DEPLOY_PATH: '/srv/fixelo'

jobs:
  # ============================================
  # BUILD & TEST
  # ============================================
  build:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate

      - name: TypeScript Check
        run: npm run type-check

      - name: Build Application
        run: npm run build
        env:
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          SKIP_ENV_VALIDATION: 'true'

  # ============================================
  # DEPLOY TO SERVER
  # ============================================
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << ENDSSH
          set -e
          
          echo "üìÅ Navigating to project directory..."
          mkdir -p /srv/fixelo
          cd /srv/fixelo
          
          # Initialize or update git repo
          if [ ! -d ".git" ]; then
            echo "üì• Cloning repository..."
            git clone ${{ github.server_url }}/${{ github.repository }}.git .
          else
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
          fi
          
          echo "üê≥ Building Docker containers..."
          docker compose -f docker-compose.prod.yml build \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" \
            --build-arg NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}" \
            --build-arg NEXT_PUBLIC_VAPID_PUBLIC_KEY="${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}" \
            --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}"
          
          echo "üöÄ Starting containers..."
          docker compose -f docker-compose.prod.yml up -d
          
          echo "üßπ Cleaning up old images..."
          docker image prune -f
          
          echo "‚úÖ Deployment complete!"
          docker ps
          ENDSSH

      - name: Health Check
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "‚è≥ Waiting for service to start..."
          sleep 30
          
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          # Check if containers are running
          if docker ps | grep -q "fixelo-web"; then
            echo "‚úÖ Web container is running"
          else
            echo "‚ùå Web container is not running"
            docker logs fixelo-web --tail 50
            exit 1
          fi
          
          # Check health endpoint
          if curl -sf http://localhost:3000/api/health > /dev/null; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed (container might still be starting)"
          fi
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
