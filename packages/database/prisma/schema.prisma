// Fixelo Platform â€” Complete Database Schema
// File: packages/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  CLEANER
  ADMIN
}

enum BookingStatus {
  DRAFT           // Created but not paid
  PENDING         // Paid, awaiting cleaner assignment
  ASSIGNED        // Cleaner assigned, awaiting acceptance
  ACCEPTED        // Cleaner accepted
  IN_PROGRESS     // Cleaner started job
  COMPLETED       // Job completed
  CANCELLED       // Cancelled by customer/admin
  REFUNDED        // Payment refunded
  DISPUTED        // Customer disputed
  RESOLVED        // Dispute resolved
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum CleanerStatus {
  PENDING_APPROVAL  // Onboarding not complete
  ACTIVE            // Available for jobs
  BUSY              // Currently on a job
  UNAVAILABLE       // Temporarily unavailable
  SUSPENDED         // Admin suspended
  DEACTIVATED       // Self-deactivated
}

enum AssignmentStatus {
  PENDING      // Waiting for cleaner acceptance
  ACCEPTED     // Cleaner accepted
  REJECTED     // Cleaner rejected
  EXPIRED      // 15-min timeout
  CANCELLED    // Booking cancelled
}

enum NotificationType {
  SMS
  EMAIL
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  phone         String?   @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole  @default(CUSTOMER)
  emailVerified DateTime?
  phoneVerified DateTime?
  stripeCustomerId String?  @unique
  
  // Password Reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())

  
  // Referral System
  referralCode  String?   @unique // Code to share (e.g. JOHN123)
  credits       Float     @default(0) // $ Wallet balance
  
  // Push Notifications
  pushSubscription Json?   // Web Push subscription object
  pushEnabled      Boolean @default(false)
  
  updatedAt     DateTime  @updatedAt

  // Relations
  cleanerProfile CleanerProfile?
  bookings       Booking[]
  reviews        Review[]
  addresses      Address[]
  notifications  Notification[]

  // Referral Relations
  referralsSent      Referral[] @relation("Referrer")
  referralReceived   Referral?  @relation("Referred")
  sentMessages       Message[]
  
  // Support
  supportTickets     SupportTicket[]
  ticketMessages     TicketMessage[]
  
  // Client ratings and blacklist (received as customer)
  clientRatings      ClientRating[]    @relation("ClientRatings")
  blacklistedBy      CleanerBlacklist[] @relation("BlacklistedClient")
  cleanerNotes       CleanerNote[]     @relation("ClientNotes")

  @@index([email])
  @@index([phone])
  @@index([role])
}

// ============================================
// CLEANER
// ============================================

model CleanerProfile {
  id                    String         @id @default(uuid())
  userId                String         @unique
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status                CleanerStatus  @default(PENDING_APPROVAL)
  rating                Float          @default(0) // 0-5
  totalRatings          Int            @default(0)
  jobsCompleted         Int            @default(0)
  jobsCancelled         Int            @default(0)
  cancellationsLast30   Int            @default(0)
  
  // Strikes System (for late cancellations)
  strikes               Int            @default(0)    // Max 3 before suspension
  lastStrikeAt          DateTime?
  strikeReasons         String?        // JSON array of strike reasons
  
  // Provider Metrics (Uber-style)
  totalJobsOffered    Int @default(0)
  totalJobsAccepted   Int @default(0)
  totalJobsCompleted  Int @default(0)
  totalLateArrivals   Int @default(0)
  
  acceptanceRate      Float @default(0) // 0-1
  completionRate      Float @default(0) // 0-1
  punctualityRate     Float @default(0) // 0-1
  qualityScore        Float @default(0) // Composite score
  
  // Onboarding & Verification
  stripeAccountId       String?        @unique
  businessType          String?        // 'INDIVIDUAL' | 'COMPANY'
  taxIdType             String?        // 'SSN' | 'ITIN' | 'EIN' - which type of tax ID
  ein                   String?        // Full EIN for companies (9 digits)
  ssnLast4              String?        // Last 4 of SSN
  itin                  String?        // Full ITIN or last 4 for individuals without SSN
  
  yearsOfExperience     Int            @default(0)
  hasInsurance          Boolean        @default(false)
  websiteUrl            String?
  instagramHandle       String?
  linkedinProfile       String?
  facebookProfileUrl    String?
  
  bio                   String?        @db.Text
  
  // Verification Docs
  idDocumentUrl         String?
  photoIdType           String?        // 'DRIVERS_LICENSE', 'PASSPORT', 'STATE_ID'
  selfieVerificationUrl String?
  selfieVerified        Boolean        @default(false)
  insuranceDocUrl       String?
  backgroundCheckStatus String?        // 'pending', 'approved', 'rejected'
  backgroundCheckId     String?
  
  verificationStatus    String         @default("PENDING") // PENDING, DOCUMENTS_NEEDED, UNDER_REVIEW, BACKGROUND_CHECK, APPROVED, REJECTED
  onboardingCompleted   Boolean        @default(false)
  onboardingStep        Int            @default(1)         // Track current step (1-5)
  
  // Document Resubmission Request
  documentRequestReason String?        // Reason why documents need to be resubmitted
  documentRequestedAt   DateTime?      // When the resubmission was requested
  documentsRequested    String?        // JSON array of document types needed: ['PHOTO_ID', 'INSURANCE', 'BACKGROUND']
  
  // Verification Timeline
  submittedAt           DateTime?
  reviewedAt            DateTime?
  reviewedBy            String?        // Admin userId
  rejectionReason       String?
  
  // Location
  latitude              Float?
  longitude             Float?
  serviceRadius         Int            @default(25) // km
  
  // Preferences
  acceptsStandard       Boolean        @default(true)
  acceptsDeep           Boolean        @default(true)
  acceptsAirbnb         Boolean        @default(true)
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Relations
  availability          CleanerAvailability[]
  assignments           CleanerAssignment[]
  payments              Payment[]
  reviews               Review[]
  payouts               Payout[]
  references            CleanerReference[]
  jobExecutions         JobExecution[]
  
  // Client management
  clientRatings         ClientRating[]
  blacklist             CleanerBlacklist[]
  privateNotes          CleanerNote[]

  @@index([status])
  @@index([latitude, longitude])
  @@index([verificationStatus])
}

// Professional References for Cleaner Verification
model CleanerReference {
  id              String         @id @default(uuid())
  cleanerId       String
  cleaner         CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  name            String
  phone           String
  email           String?
  relationship    String         // "Former Client", "Employer", "Colleague"
  
  // Admin Contact Tracking
  contacted       Boolean        @default(false)
  contactedAt     DateTime?
  contactedBy     String?        // Admin userId
  verified        Boolean        @default(false)
  notes           String?        @db.Text
  
  createdAt       DateTime       @default(now())
  
  @@index([cleanerId])
}

model CleanerAvailability {
  id        String      @id @default(uuid())
  cleanerId String
  cleaner   CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  dayOfWeek DayOfWeek
  startTime String      // '09:00' (24h format)
  endTime   String      // '17:00'
  isActive  Boolean     @default(true)
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([cleanerId, dayOfWeek, startTime])
  @@index([cleanerId, isActive])
}

// ============================================
// SERVICE TYPES & ADD-ONS
// ============================================

model ServiceType {
  id          String    @id @default(uuid())
  name        String    @unique // 'Standard Cleaning', 'Deep Cleaning', 'Airbnb Cleaning'
  slug        String    @unique // 'standard', 'deep', 'airbnb'
  description String?
  
  // Pricing base (can be overridden by region)
  basePrice   Float     // USD
  
  // Inclusions (JSON)
  inclusions  Json      // ['Dusting', 'Vacuum', 'Mopping', ...]
  exclusions  Json?     // ['Inside oven', 'Inside fridge', ...]
  
  // Time estimation
  baseTime    Int       // minutes (base time)
  timePerBed  Int       // additional minutes per bedroom
  timePerBath Int       // additional minutes per bathroom

  // Pricing Multipliers
  pricePerBed Float     @default(20.00)
  pricePerBath Float    @default(25.00)
  pricePerPet Float     @default(15.00)
  
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  bookings           Booking[]
  checklistTemplates ChecklistTemplate[]

  @@index([slug])
}

model AddOn {
  id          String    @id @default(uuid())
  name        String    @unique // 'Inside Oven', 'Inside Fridge'
  slug        String    @unique // 'inside-oven'
  description String?
  price       Float     // Additional USD
  timeAdded   Int       // Additional minutes
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  bookingAddOns BookingAddOn[]

  @@index([isActive])
}

// ============================================
// BOOKING
// ============================================

model Booking {
  id                     String        @id @default(uuid())
  userId                 String
  user                   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  serviceTypeId          String
  serviceType            ServiceType   @relation(fields: [serviceTypeId], references: [id])
  
  status                 BookingStatus @default(DRAFT)
  
  // Scheduling
  scheduledDate          DateTime
  timeWindow             String        // '09:00-12:00'
  estimatedDuration      Int           // minutes
  
  // Home details
  bedrooms               Int
  bathrooms              Int
  squareFootage          Int?
  hasPets                Boolean       @default(false)
  specialInstructions    String?       @db.Text
  
  // Address (can be from saved addresses or one-time)
  addressId              String?
  address                Address?      @relation(fields: [addressId], references: [id])
  addressSnapshot        Json          // Store address even if Address deleted
  
  // Pricing
  basePrice              Float
  addOnsTotal            Float         @default(0)
  subtotal               Float
  stripeFee              Float         // Calculated
  platformReserve        Float         // Insurance/reserve
  totalPrice             Float
  
  // Tips (100% goes to cleaner)
  tipAmount              Float         @default(0)
  tipPaidAt              DateTime?
  
  // Recurring Booking
  recurringId            String?
  recurring              RecurringBooking? @relation(fields: [recurringId], references: [id])
  discountPercent        Float         @default(0)    // Applied recurring discount
  discountAmount         Float         @default(0)
  
  // Payment
  stripePaymentIntentId  String?       @unique
  
  // Cancellation
  cancelledAt            DateTime?
  cancelledBy            String?       // userId
  cancellationReason     String?
  cancellationFee        Float         @default(0)    // Fee charged if late cancellation
  
  // Quality Guarantee
  recleanRequested       Boolean       @default(false)
  recleanRequestedAt     DateTime?
  recleanReason          String?
  recleanBookingId       String?       // Link to the re-clean booking
  qualityIssueRefunded   Boolean       @default(false)
  refundReason           String?
  

  // Financial & Payouts
  payoutId               String?
  payout                 Payout?       @relation(fields: [payoutId], references: [id])
  payoutStatus           String        @default("PENDING") // PENDING, PAID, HOLD
  payoutEligibleAt       DateTime?
  disputeStatus          String?       // OPEN, RESOLVED_CLEANER, RESOLVED_CUSTOMER

  // Messages
  messages               Message[]

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  addOns                 BookingAddOn[]
  assignments            CleanerAssignment[]
  payment                Payment?
  review                 Review?
  jobExecution           JobExecution?
  serviceReport          ServiceReport?
  supportTickets         SupportTicket[] @relation("SupportTickets")

  @@index([userId])
  @@index([status])
  @@index([scheduledDate])
  @@index([serviceTypeId])
}

model BookingAddOn {
  id        String   @id @default(uuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  addOnId   String
  addOn     AddOn    @relation(fields: [addOnId], references: [id])
  
  price     Float    // Snapshot of price at time of booking
  quantity  Int      @default(1)
  
  createdAt DateTime @default(now())

  @@unique([bookingId, addOnId])
  @@index([bookingId])
}

// ============================================
// CLEANER ASSIGNMENT
// ============================================

model CleanerAssignment {
  id        String           @id @default(uuid())
  bookingId String
  booking   Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  cleanerId String
  cleaner   CleanerProfile   @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  status    AssignmentStatus @default(PENDING)
  
  // Score used for assignment (for analytics)
  matchScore Float?
  
  // Acceptance window
  expiresAt  DateTime         // 15 minutes from creation
  acceptedAt DateTime?
  rejectedAt DateTime?
  
  // Job execution
  startedAt  DateTime?
  completedAt DateTime?
  
  // Distance (for analytics)
  distanceKm Float?
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([bookingId])
  @@index([cleanerId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// PAYMENT
// ============================================

model Payment {
  id                    String        @id @default(uuid())
  bookingId             String        @unique
  booking               Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  // Customer payment
  amount                Float
  stripeFee             Float
  platformReserve       Float
  netAmount             Float         // After fees
  
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?       @unique
  status                PaymentStatus @default(PENDING)
  
  paidAt                DateTime?
  
  // Cleaner payout
  cleanerId             String?
  cleaner               CleanerProfile? @relation(fields: [cleanerId], references: [id])
  
  cleanerAmount         Float?        // 70% of net
  platformAmount        Float?        // 30% of net
  
  stripeTransferId      String?       @unique
  paidOutAt             DateTime?
  
  // Refund
  refundedAmount        Float?
  refundedAt            DateTime?
  stripeRefundId        String?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([bookingId])
  @@index([cleanerId])
  @@index([status])
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id        String   @id @default(uuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId    String   // Customer who wrote review
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  cleanerId String   // Cleaner being reviewed
  cleaner   CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5
  comment   String?  @db.Text
  
  // Optional detailed ratings
  qualityRating      Int?  // 1-5
  punctualityRating  Int?  // 1-5
  friendlinessRating Int?  // 1-5
  
  isPublic  Boolean  @default(false) // For future use
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cleanerId])
  @@index([rating])
}

// ============================================
// ADDRESSES
// ============================================

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label     String?  // 'Home', 'Office', etc.
  
  street    String
  unit      String?
  city      String
  state     String   // 2-letter code
  zipCode   String
  country   String   @default("US")
  
  // Geocoding
  latitude  Float?
  longitude Float?
  
  // Access instructions
  accessInstructions String? @db.Text // 'Leave key with doorman'
  
  isDefault Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings      Booking[]
  cleanerNotes  CleanerNote[]

  @@index([userId])
  @@index([latitude, longitude])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String             @id @default(uuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  status    NotificationStatus @default(PENDING)
  
  // Content
  subject   String?
  body      String             @db.Text
  
  // Delivery
  sentAt    DateTime?
  deliveredAt DateTime?
  failedAt  DateTime?
  errorMessage String?
  
  // External IDs
  twilioSid String?            @unique
  sendgridId String?           @unique
  
  // Metadata
  metadata  Json?              // Booking ID, etc.
  
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  // Null if system action
  action    String   // 'booking.created', 'cleaner.suspended'
  entity    String   // 'Booking', 'User'
  entityId  String   // ID of affected entity
  
  changes   Json?    // { before: {...}, after: {...} }
  metadata  Json?    // Additional context
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityId])
  @@index([createdAt])
}

// ============================================
// SYSTEM CONFIG (for admin)
// ============================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique // 'stripe_fees_percentage', 'platform_commission'
  value     String   // JSON-stringified value
  
  description String?
  
  updatedBy String?  // Admin userId
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
}

// ============================================
// FINANCIAL & SETTINGS
// ============================================

model FinancialSettings {
  payoutSchedule        String   @default("WEEKLY")
  payoutDay             String   @default("FRIDAY")
  minPayoutAmount       Float    @default(50)
  holdDaysAfterService  Int      @default(2)
  requireCustomerReview Boolean  @default(true)
  
  updatedAt             DateTime @updatedAt
}

// ============================================
// RECURRING BOOKINGS
// ============================================

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model RecurringBooking {
  id                String             @id @default(uuid())
  userId            String
  
  // Service Details
  serviceTypeId     String
  addressId         String
  bedrooms          Int
  bathrooms         Int
  hasPets           Boolean            @default(false)
  specialInstructions String?          @db.Text
  preferredDay      DayOfWeek
  preferredTime     String             // '09:00-12:00'
  
  // Frequency & Discount
  frequency         RecurringFrequency
  discountPercent   Float              // Applied discount based on frequency
  
  // Status
  isActive          Boolean            @default(true)
  nextBookingDate   DateTime?
  lastBookingDate   DateTime?
  totalBookings     Int                @default(0)
  
  // Preferred Cleaner (optional)
  preferredCleanerId String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  bookings          Booking[]
  
  @@index([userId])
  @@index([isActive])
}

model Payout {
  id                String         @id @default(uuid())
  cleanerId         String
  cleaner           CleanerProfile @relation(fields: [cleanerId], references: [id])
  
  amount            Float
  currency          String   @default("usd")
  status            String   // PENDING, PAID, FAILED
  
  periodStart       DateTime
  periodEnd         DateTime
  
  bookings          Booking[]
  
  stripePayoutId    String?
  paidAt            DateTime?
  failureReason     String?
  
  createdAt         DateTime @default(now())
  
  @@index([cleanerId])
}

model Referral {
  id                String   @id @default(uuid())
  referrerId        String
  referrer          User     @relation("Referrer", fields: [referrerId], references: [id])
  referredId        String   @unique
  referred          User     @relation("Referred", fields: [referredId], references: [id])
  
  status            String   // PENDING, QUALIFIED, PAID
  bonusAmount       Float    @default(20)
  paidAt            DateTime?
  
  createdAt         DateTime @default(now())
}

model Message {
  id         String   @id @default(uuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  senderId   String
  sender     User     @relation(fields: [senderId], references: [id])
  
  content    String   @db.Text
  read       Boolean  @default(false)
  
  createdAt  DateTime @default(now())
  
  @@index([bookingId])
  @@index([senderId])
}

// ============================================
// QUALITY ISSUES & DISPUTES
// ============================================

enum QualityIssueStatus {
  OPEN
  RECLEAN_SCHEDULED
  REFUNDED
  RESOLVED
  REJECTED
}

model QualityIssue {
  id              String             @id @default(uuid())
  bookingId       String
  userId          String             // Customer who reported
  cleanerId       String             // Cleaner involved
  
  // Issue Details
  issueType       String             // 'INCOMPLETE', 'DAMAGE', 'NO_SHOW', 'POOR_QUALITY'
  description     String             @db.Text
  photos          String?            // JSON array of photo URLs
  
  // Resolution
  status          QualityIssueStatus @default(OPEN)
  resolution      String?            // 'RECLEAN', 'PARTIAL_REFUND', 'FULL_REFUND', 'CREDIT'
  resolutionNotes String?            @db.Text
  
  // Financial
  refundAmount    Float?
  creditAmount    Float?
  recleanBookingId String?           // If re-clean was scheduled
  
  // Admin
  assignedTo      String?            // Admin userId handling
  resolvedBy      String?
  resolvedAt      DateTime?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@index([bookingId])
  @@index([userId])
  @@index([cleanerId])
  @@index([status])
}

// ============================================
// JOB EXECUTION (Check-in/Check-out Flow)
// ============================================

enum JobExecutionStatus {
  NOT_STARTED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
}

model JobExecution {
  id            String             @id @default(uuid())
  bookingId     String             @unique
  booking       Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  cleanerId     String
  cleaner       CleanerProfile     @relation(fields: [cleanerId], references: [id])
  
  status        JobExecutionStatus @default(NOT_STARTED)
  
  // Check-in/out times
  checkedInAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  
  // Location verification
  checkinLat    Float?
  checkinLng    Float?
  checkoutLat   Float?
  checkoutLng   Float?
  
  // Notes
  notes         String?            @db.Text
  
  // Checklist completion
  checklistCompletedAt DateTime?
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  // Relations
  photos        JobPhoto[]
  checklist     JobChecklistItem[]
  
  @@index([bookingId])
  @@index([cleanerId])
  @@index([status])
}

enum JobPhotoType {
  BEFORE
  AFTER
}

model JobPhoto {
  id              String        @id @default(uuid())
  jobExecutionId  String
  jobExecution    JobExecution  @relation(fields: [jobExecutionId], references: [id], onDelete: Cascade)
  
  type            JobPhotoType  // BEFORE or AFTER
  url             String        // S3 URL
  s3Key           String        // S3 key for deletion
  
  room            String?       // e.g., "Kitchen", "Bathroom", "Living Room"
  caption         String?
  
  createdAt       DateTime      @default(now())
  
  @@index([jobExecutionId])
  @@index([type])
}

model JobChecklistItem {
  id              String        @id @default(uuid())
  jobExecutionId  String
  jobExecution    JobExecution  @relation(fields: [jobExecutionId], references: [id], onDelete: Cascade)
  
  category        String        // e.g., "Kitchen", "Bathroom", "General"
  task            String        // e.g., "Clean countertops", "Mop floor"
  isRequired      Boolean       @default(true)
  
  completed       Boolean       @default(false)
  completedAt     DateTime?
  notes           String?
  
  sortOrder       Int           @default(0)
  
  createdAt       DateTime      @default(now())
  
  @@index([jobExecutionId])
  @@index([category])
}

// Default checklist templates per service type
model ChecklistTemplate {
  id            String                   @id @default(uuid())
  serviceTypeId String?
  serviceType   ServiceType?             @relation(fields: [serviceTypeId], references: [id])
  
  name          String                   // e.g., "Standard Cleaning", "Deep Cleaning"
  isDefault     Boolean                  @default(false)
  
  items         ChecklistTemplateItem[]
  
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  
  @@index([serviceTypeId])
}

model ChecklistTemplateItem {
  id          String            @id @default(uuid())
  templateId  String
  template    ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  category    String
  task        String
  isRequired  Boolean           @default(true)
  sortOrder   Int               @default(0)
  
  @@index([templateId])
}

// ============================================
// SUPPORT TICKETS
// ============================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  WAITING_CLEANER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  BOOKING_ISSUE
  PAYMENT_ISSUE
  CLEANER_COMPLAINT
  CUSTOMER_COMPLAINT
  SERVICE_QUALITY
  TECHNICAL_ISSUE
  ACCOUNT_ISSUE
  OTHER
}

model SupportTicket {
  id            String         @id @default(uuid())
  ticketNumber  String         @unique  // e.g., "TKT-0001234"
  
  userId        String         // Who opened the ticket
  user          User           @relation(fields: [userId], references: [id])
  
  // Optional associations
  bookingId     String?
  booking       Booking?       @relation("SupportTickets", fields: [bookingId], references: [id])
  cleanerId     String?
  
  category      TicketCategory
  subject       String
  description   String         @db.Text
  
  status        TicketStatus   @default(OPEN)
  priority      TicketPriority @default(MEDIUM)
  
  // Assignment
  assignedTo    String?        // Admin userId
  
  // Resolution
  resolvedAt    DateTime?
  resolution    String?        @db.Text
  
  // Metadata
  source        String         @default("app") // 'app', 'email', 'phone'
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  messages      TicketMessage[]
  attachments   TicketAttachment[]
  
  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([priority])
}

model TicketMessage {
  id          String        @id @default(uuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  senderId    String
  sender      User          @relation(fields: [senderId], references: [id])
  
  content     String        @db.Text
  isInternal  Boolean       @default(false) // For admin-only notes
  
  createdAt   DateTime      @default(now())
  
  @@index([ticketId])
  @@index([senderId])
}

model TicketAttachment {
  id          String        @id @default(uuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  fileName    String
  fileType    String
  fileSize    Int
  url         String
  s3Key       String
  
  uploadedBy  String
  
  createdAt   DateTime      @default(now())
  
  @@index([ticketId])
}

// ============================================
// CLIENT RATING (Cleaner rates Customer)
// ============================================

model ClientRating {
  id            String         @id @default(uuid())
  cleanerId     String
  cleaner       CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  clientId      String
  client        User           @relation("ClientRatings", fields: [clientId], references: [id], onDelete: Cascade)
  
  bookingId     String         @unique
  
  rating        Int            // 1-5 stars
  categories    Json?          // { punctuality: 5, communication: 4, cleanliness: 5, respect: 5 }
  comment       String?        @db.Text
  isPrivate     Boolean        @default(true) // Private by default (only cleaner sees)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@unique([cleanerId, bookingId])
  @@index([cleanerId])
  @@index([clientId])
}

// ============================================
// CLEANER BLACKLIST
// ============================================

model CleanerBlacklist {
  id            String         @id @default(uuid())
  cleanerId     String
  cleaner       CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  clientId      String
  client        User           @relation("BlacklistedClient", fields: [clientId], references: [id], onDelete: Cascade)
  
  reason        String?        @db.Text
  
  createdAt     DateTime       @default(now())
  
  @@unique([cleanerId, clientId])
  @@index([cleanerId])
  @@index([clientId])
}

// ============================================
// CLEANER PRIVATE NOTES
// ============================================

model CleanerNote {
  id            String         @id @default(uuid())
  cleanerId     String
  cleaner       CleanerProfile @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  
  // Can be tied to a client OR address OR both
  clientId      String?
  client        User?          @relation("ClientNotes", fields: [clientId], references: [id], onDelete: Cascade)
  
  addressId     String?
  address       Address?       @relation(fields: [addressId], references: [id], onDelete: Cascade)
  
  title         String?
  content       String         @db.Text
  
  // Tags for organization
  tags          String?        // JSON array: ["parking", "pets", "access-code"]
  
  // Reminder for next visit
  reminderText  String?
  showOnNextJob Boolean        @default(false)
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([cleanerId])
  @@index([clientId])
  @@index([addressId])
}

// ============================================
// SERVICE REPORT (PDF Generation)
// ============================================

model ServiceReport {
  id              String         @id @default(uuid())
  bookingId       String         @unique
  booking         Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  generatedAt     DateTime       @default(now())
  
  // S3 storage
  pdfUrl          String?
  s3Key           String?
  
  // Report data snapshot
  reportData      Json           // Snapshot of checklist, photos, times, etc.
  
  // Sent to customer
  emailedAt       DateTime?
  emailedTo       String?
  
  @@index([bookingId])
}
