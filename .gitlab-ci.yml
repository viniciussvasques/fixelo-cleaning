# ============================================
# FIXELO CI/CD PIPELINE - GitLab
# ============================================

stages:
  - install
  - lint
  - test
  - security
  - build
  - deploy

default:
  image: node:20-alpine
  cache:
    key:
      files:
        - package-lock.json
        - turbo.json
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
      - .npm/
    policy: pull-push

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  NODE_ENV: "production"

# ============================================
# INSTALL & CACHE DEPENDENCIES
# ============================================
install:
  stage: install
  tags:
    - docker
    - linux
  script:
    - npm ci
    - npm run db:generate
  artifacts:
    paths:
      - node_modules/
      - apps/*/node_modules/
      - packages/*/node_modules/
      - packages/database/node_modules/.prisma/
    expire_in: 1 hour

# ============================================
# LINT & TYPE CHECK
# ============================================
lint:
  stage: lint
  tags:
    - docker
    - linux
  needs:
    - install
  script:
    - npm run lint
  allow_failure: true

type-check:
  stage: lint
  tags:
    - docker
    - linux
  needs:
    - install
  script:
    - npm run type-check

# ============================================
# TESTS
# ============================================
test:unit:
  stage: test
  tags:
    - docker
    - linux
  needs:
    - install
  script:
    - npm run test:unit
  allow_failure: true
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

test:integration:
  stage: test
  tags:
    - docker
    - linux
  needs:
    - install
  script:
    - npm run test:integration
  allow_failure: true

# ============================================
# SECURITY
# ============================================
security:audit:
  stage: security
  tags:
    - docker
    - linux
  needs:
    - install
  script:
    - npm audit --audit-level=high || true
  allow_failure: true

dependency-scanning:
  stage: security
  image:
    name: registry.gitlab.com/gitlab-org/security-products/analyzers/gemnasium:latest
  script:
    - /analyzer run
  allow_failure: true
  only:
    - main
    - master
    - develop

# ============================================
# BUILD
# ============================================
build:
  stage: build
  tags:
    - docker
    - linux
  needs:
    - lint
    - type-check
    - test:unit
  script:
    - npm run build
  artifacts:
    paths:
      - apps/web/.next/
      - apps/web/public/
    expire_in: 1 week
  variables:
    SKIP_ENV_VALIDATION: "true"

# ============================================
# DEPLOY STAGING
# ============================================
deploy:staging:
  stage: deploy
  tags:
    - docker
    - linux
  needs:
    - build
  environment:
    name: staging
    url: $STAGING_URL
  script:
    - echo "Deploying to staging..."
    # Add your deployment commands here
    # Examples:
    # - npx vercel --token=$VERCEL_TOKEN
    # - docker build -t fixelo:staging .
    # - kubectl apply -f k8s/staging/
  only:
    - develop
  when: manual

# ============================================
# DEPLOY PRODUCTION
# ============================================
deploy:production:
  stage: deploy
  tags:
    - docker
    - linux
  needs:
    - build
  environment:
    name: production
    url: $PRODUCTION_URL
  script:
    - echo "Deploying to production..."
    # Add your production deployment commands here
  only:
    - main
    - master
  when: manual

# ============================================
# SONARQUBE ANALYSIS
# ============================================
sonarqube:
  stage: security
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
      -Dsonar.projectKey=fixelo
      -Dsonar.projectName=Fixelo
      -Dsonar.sources=apps/web/src
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.qualitygate.wait=true
  allow_failure: true
  only:
    - main
    - master
    - develop
